---
title: "ä¸€ä¸ªç”¨äºåœ¨ Typescript ä¸­å°† Union è½¬åŒ–ä¸º Set çš„å·¥å…·ç±»å‹"
excerpt: "æœ¬æ–‡ä»ä¸šåŠ¡è§’åº¦å‡ºå‘ï¼Œç¼–å†™äº†ä¸€ä¸ªç±»å‹å·¥å…·ï¼Œç”¨æ¥å°† Union è½¬æ¢ä¸º Set"
date: "2023-01-30"
locale: "zh"
tags: [TypeScript]
coverImage: https://rorsch-1256426089.file.myqcloud.com/public/202301310013066.png
---

## Motivation

æƒ³è±¡ä¸€ä¸‹ä½ åœ¨åšä¸€ä¸ª Todo åº”ç”¨ã€‚
![homer çš„ å¾…åŠäº‹é¡¹](https://rorsch-1256426089.file.myqcloud.com/public/202301302120989.webp)
è¿™ä¸ªé¡µé¢é€šè¿‡è°ƒç”¨ä¸€ä¸ª HTTP API æ¥è·å–æ‰€æœ‰çš„å¾…åŠäº‹é¡¹ã€‚ä½ å’Œåç«¯çš„åŒäº‹çº¦å®šå¥½äº†ä¸€ä¸ªå¾…åŠäº‹é¡¹æ•°æ®ç±»å‹ï¼š

```typescript
type Todo = {
  id: number;
  title: string;
  description: string;
  /**
   * 0 ä»£è¡¨å¾…åŠï¼Œ1 ä»£è¡¨å®Œæˆ
   */
  status: 0 | 1;
};
```

è¿™ä¸ª Todo åº”ç”¨æœ‰ä¸€ä¸ªç”¨æ¥ç­›é€‰å‡ºæœªå®Œæˆ/å·²å®Œæˆçš„äº‹é¡¹çš„ç­›é€‰æ¡†ï¼Œä½ å¯èƒ½ä¼šç ä¸€ä¸ªå¦‚ä¸‹çš„æ•°æ®ç»“æ„æ¥ä»£è¡¨ç­›é€‰æ¡†çš„æ‰€æœ‰é€‰é¡¹ï¼š

```typescript
const statusFilterOptions = [
  {
    value: 0,
    label: "active",
  },
  {
    value: 1,
    label: "completed",
  },
];
```

ä¸ºäº†é˜²æ­¢åŒäº‹æˆ–ä½ è‡ªå·±åœ¨æ—¥åé‡æ„è¿™æ®µä»£ç æ—¶æ‰‹æ»‘è¾“å‡ºä¸€ä¸ª bugï¼Œ ä½ å¯èƒ½ä¼šç»™æ­¤é€‰é¡¹å®šä¹‰ä¸€ä¸ªç±»å‹ï¼š

```typescript
type Option = {
  value: Todo["status"];
  label: string;
};

const statusFilterOptions: Option[] = [
  {
    value: 0,
    label: "active",
  },
  {
    value: 1,
    label: "completed",
  },
];
```

ä¸€èˆ¬æ¥è®²ï¼Œå¦‚æœä½ çš„å›¢é˜Ÿåªæ˜¯ç®€å•çš„ä½¿ç”¨ Typescript çš„è¯ï¼Œåˆ°è¿™é‡Œå°±å¤Ÿäº†ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³å°† `statusFilterOptions`çš„ç±»å‹å®šä¹‰å¾—æ›´ç²¾ç¡®ï¼Œè¿™é‡Œè¿˜å¯ä»¥èµ°çš„æ›´è¿œã€‚ä»¥ä¸‹å‡ ç§ `statusFilterOptions`çš„ä¾‹å­è™½ç„¶æ»¡è¶³äº†`Option`ç±»å‹ï¼Œæ”¾åˆ°ç”Ÿäº§ç¯å¢ƒå´ä¼šè®©ç”¨æ¥ **ç­›é€‰å‡ºæœªå®Œæˆ/å·²å®Œæˆçš„äº‹é¡¹** çš„ç­›é€‰æ¡†ç»„ä»¶äº§ç”Ÿ bug:

```typescript
// é€‰é¡¹çš„ value ç›¸åŒ
const statusFilterOptions: Option[] = [
  {
    value: 1,
    label: "active",
  },
  {
    value: 1,
    label: "completed",
  },
];

// é€‰é¡¹å°‘å†™äº†ä¸€ä¸ª
const statusFilterOptions: Option[] = [
  {
    value: 1,
    label: "active",
  },
];

// é€‰é¡¹å¤šå†™äº†ä¸€ä¸ª
const statusFilterOptions: Option[] = [
  {
    value: 0,
    label: "active",
  },
  {
    value: 1,
    label: "completed",
  },
  {
    value: 2,
    label: "completed",
  },
];
```

ä¸æ­¢æ˜¯ä¸ºäº†æ¶ˆç­ä»¥ä¸Šå‡ ç§ bug case, æƒ³è±¡ä¸€ä¸‹å®é™…çš„ä¸šåŠ¡åœºæ™¯ï¼Œäº§å“å¯èƒ½ç»å¸¸å˜æ›´ï¼Œtodo çš„ status è™½ç„¶ç°åœ¨åªæœ‰ 0 ä¸ 1 ä¸¤ç§ï¼Œå¯èƒ½åœ¨ä¹‹åå˜æˆ 0 ï¼Œ1 ä¸ 2 ä¸‰ç§ï¼Œä¸ºäº†é˜²æ­¢åªä¿®æ”¹ `Todo`ç±»å‹è€Œç­›é€‰å™¨é€‰é¡¹æœªåŒæ­¥ä¿®æ”¹çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸‹ç±»å‹ä½“æ“ï¼Œç¼–å†™ä¸€ä¸ªåœ¨è¯¸å¦‚æ­¤ç±»åœºæ™¯ä¸‹å¯ä»¥å¹¿æ³›ä½¿ç”¨çš„ç±»å‹ã€‚

## Coding

é¦–å…ˆæ€è€ƒä¸€ä¸‹æˆ‘ä»¬ç±»å‹çš„è¾“å…¥è¾“å‡ºï¼Œæˆ‘ä»¬æœŸæœ›è¾“å…¥çš„ç±»å‹æ˜¯`0 | 1` æˆ– `male | female`è¿™æ ·çš„é›†åˆï¼ŒæœŸæœ›è¾“å‡ºçš„ç±»å‹åº”è¯¥æ˜¯ç²¾å‡†åŒ…å«é›†åˆä¸­æ‰€æœ‰å…ƒç´ çš„æ•°ç»„ï¼Œä¸€ä¸ªä¸èƒ½å¤šï¼Œä¸€ä¸ªä¸èƒ½å°‘ ğŸ™…â€â™€ï¸ï¼Œå¹¶ä¸”æ•°ç»„å…ƒç´ çš„é¡ºåºæ˜¯å¯ä»¥æ”¹å˜çš„ã€‚å¾ˆå®¹æ˜“å°±å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªå°† `union` è½¬æ¢ä¸º `set` çš„ç±»å‹ã€‚ä¸‹åˆ—ä¸º `UnionToSet`ä»£ç ï¼š

```typescript
type UnionToSet<
  U extends string | number | symbol,
  R extends (string | number | symbol)[] = []
> = {
  [S in U]: Exclude<U, S> extends never
    ? [...R, S]
    : UnionToSet<Exclude<U, S>, [...R, S]>;
}[U];
```

ä¸Šè¿°ä»£ç é€šè¿‡é€’å½’éå† U æ¥å®ç°è½¬æ¢ï¼Œéœ€è¦æ³¨æ„ âš ï¸ ä»¥ä¸‹ä¸‰ç‚¹ï¼š

- **ä½¿ç”¨äº† TypeScript 4.0 ç‰ˆæœ¬æä¾›çš„é‡é‡çº§åŠŸèƒ½: [å¯å˜å…ƒç»„ç±»å‹(Variadic Tuple Types)](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-0.html#variadic-tuple-types)**ã€‚æ‰€ä»¥åªèƒ½åœ¨ TypeScript 4.0 åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨ã€‚
- **åŸºäºé€’å½’**ã€‚è™½ç„¶ [TypeScript 4.5 å¯¹å°¾é€’å½’æœ‰ä¼˜åŒ–](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-5.html#tail-recursion-elimination-on-conditional-types)ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰åŠæ³•è½¬æ¢æˆå°¾é€’å½’çš„æ¨¡å¼ï¼Œæ‰€ä»¥è¯·ä¸è¦åœ¨é›†åˆå¤ªå¤§çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚
- **Object é”®ç±»å‹çº¦æŸ**ã€‚åŸºäº JavaScript Object é”®çš„é™åˆ¶ï¼ŒTypeScript é™åˆ¶åœ¨ä¸Šæ–‡çš„`[S in U]`ä¸­ U çš„ç±»å‹å¿…é¡»æ´¾ç”Ÿè‡ª`string | numebr | symbol`ï¼Œæ‰€ä»¥å¦‚`true | false`è¿™æ ·çš„ union æ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨æ­¤ç±»å‹çš„ã€‚å½“ç„¶, å› ä¸º boolean ç±»å‹çš„å€¼åªæœ‰ 2 ä¸ªï¼Œæ‰“é”™äº† IDE ä¹Ÿä¼šæœ‰æç¤ºï¼Œæ‰€ä»¥ä¹Ÿä¸å¤ªéœ€è¦ç‰¹åœ°å»çº¦æŸç±»å‹ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªå°ä¼˜åŒ–ï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼ŒU æ´¾ç”Ÿè‡ª `string | number`, R æ´¾ç”Ÿè‡ª `string | number`,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠ½è±¡å‡ºæ­¤ç±»å‹ï¼Œå¹¶å¯¹ä½¿ç”¨è€…å±è”½ U ä¸ Rï¼š

```typescript
type UnionToSetHelper<
  T extends keyof any,
  U extends T = T,
  R extends T[] = []
> = {
  [S in U]: Exclude<U, S> extends never
    ? [...R, S]
    : UnionToSetHelper<T, Exclude<U, S>, [...R, S]>;
}[U];

export type UnionToSet<T extends keyof any> = UnionToSetHelper<T>;
```

ä»¥ä¸‹ä¸ºæµ‹è¯•ç”¨ä¾‹:

```typescript
const a: UnionToSet<0 | 1> = [0, 1]; // âœ…
const a: UnionToSet<0 | 1> = [1, 0]; // âœ…
const b: UnionToSet<0 | 1> = [0, 1, 2]; // â
const c: UnionToSet<0 | 1> = [0]; // â
const d: UnionToSet<0 | 1> = [1, 1]; // â
```

åŸºäºæˆ‘ä»¬æ„é€ çš„`UnionToSet`çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸ç®€å•çš„ç å‡ºä¸€ä¸ªä¸ä¸šåŠ¡å¼ºç»“åˆçš„ `Options`ç±»å‹ï¼š

```typescript
type Option<T extends keyof any> = {
  value: T;
  label: string;
};

type OptionsHelper<
  T extends keyof any,
  U extends T = T,
  R extends Option<T>[] = []
> = {
  [S in U]: Exclude<U, S> extends never
    ? [...R, Option<S>]
    : OptionsHelper<T, Exclude<U, S>, [...R, Option<S>]>;
}[U];

type Options<T extends keyof any> = OptionsHelper<T>;
```

ä»¥ä¸‹ä¸º Todo demoï¼Œå¯ä»¥ fork ä¹‹åå°è¯•ä¿®æ”¹ `src/App.tsx`ä¸­ `Todo`ç±»å‹ã€‚

<iframe
  src="https://codesandbox.io/embed/demo-of-suikos-blog-union-to-set-d2c3xi?fontsize=14&hidenavigation=1"
  style={{
    width: "100%",
    height: "500px",
    border: 0,
    borderRadius: 4,
    overflow: "hidden",
  }}
  title="demo of suiko&#039;s blog union-to-set"
  allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
  sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
></iframe>

## Bonus

æœ¬æ–‡ä¸»è¦ä»‹ç»äº†`union to set`çš„æƒ…å†µï¼Œå¾ˆè‡ªç„¶çš„å¯ä»¥æƒ³åˆ°æ˜¯å¦å¯ä»¥å°†`union`è½¬æ¢ä¸º`tuple`ï¼Œå¯ä»¥è·³è½¬è‡³ [æ­¤ issue](https://github.com/microsoft/TypeScript/issues/13298) æŸ¥çœ‹å¤§å®¶çš„è®¨è®ºã€‚
ä¹Ÿå¯ä»¥åœ¨ [type-challenges](https://github.com/type-challenges/type-challenges) é¢˜åº“ä¸­æŸ¥çœ‹ [æ­¤é¢˜](https://github.com/type-challenges/type-challenges/blob/main/questions/00730-hard-union-to-tuple/README.md)ã€‚
